<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="color-scheme" content="light dark">
  <title>rMeta</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- üåó Theme Toggle Controls -->
  <div class="theme-toggle-wrapper" style="text-align:center; margin-bottom: 1em;">
    <div id="themeLabel" style="font-size: 0.9em; margin-bottom: 4px;">System</div>
    <button id="themeToggle" title="Toggle theme (Next: Dark)">üñ•Ô∏è</button>
  </div>

  <h2>Upload files to remove metadata</h2>

  <!-- üßº Upload form -->
  <form method="post" enctype="multipart/form-data" action="{{ url_for('upload.upload_file') }}" id="upload-form">
    <label for="file-upload" class="drop-zone" id="drop-zone">
      <p>Drag & drop files here or click to select</p>
      <input type="file" id="file-upload" name="file" multiple accept=".jpg,.jpeg,.png,.heic,.pdf,.docx,.xlsx,.csv,.txt">
    </label>

    <label><input type="checkbox" name="generate_hash"> Generate hash (.sha256.txt)</label><br>
    <label><input type="checkbox" name="encrypt_file"> Encrypt output with GPG</label><br>

    <label>
      Public GPG key (.asc or .gpg): 
      <input type="file" name="gpg_key" accept=".asc,.gpg">
    </label><br>

    <input type="submit" value="Upload">
  </form>

  <!-- üßº Memory Clean Button -->
  <form method="POST" action="{{ url_for('session_clean.clean_memory') }}" id="clean-form">
    <button
      type="submit"
      class="clean-btn"
      id="clean-memory-btn"
      title="Removes temporary session data"
    >
      <span id="clean-btn-text">Checking...</span>
    </button>
    <div class="tooltip">Removes temporary session data</div>
  </form>
  <button onclick="document.getElementById('debug-dump').classList.toggle('hidden')">
    Show/Hide Debug Info
  </button>
  <pre id="debug-dump" class="hidden">{{ files | tojson(indent=2) }}</pre>

  <!-- üìú Status messages -->
  {% if messages %}
    <div class="messages">
      <ul>
      {% for msg in messages %}
        {% if "‚ö†Ô∏è" in msg %}
          <li><strong>{{ msg }}</strong></li>
        {% else %}
          <li>{{ msg }}</li>
        {% endif %}
      {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- üìä File Processing Summary -->
  {% if files %}
    <h3>File Processing Summary</h3>
      <table>
        <thead>
          <tr>
            <th>Filename</th>
            <th>Warnings</th>
            <th>Metadata Status</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %}
            <tr>
              <td>{{ file.filename }}</td>
            <td>
              {% set has_flagged = false %}
              <ul>
                {% for warn in file.warnings %}
                  {% if "‚ö†Ô∏è" in warn %}
                    {% set has_flagged = true %}
                    <li>{{ warn }}</li>
                  {% endif %}
                {% endfor %}
              </ul>
              {% if not has_flagged %}
                ‚Äî
              {% endif %}
            </td>
              <td>
                {% if file.metadata_msg and "Metadata stripped" in file.metadata_msg %}
                  ‚úÖ Pass
                {% else %}
                  ‚ùå Fail
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

    <!-- üì• Download Summary -->
    <h3>Download Summary</h3>
    <table>
      <thead>
        <tr>
          <th>Download</th>
          <th>SHA256 Hash</th>
          <th>Encrypted?</th>
        </tr>
      </thead>
      <tbody>
        {% for file in files %}
          <tr>
            <td>
              {% if session and file.filename %}
                <a href="{{ url_for('download.download_file', session=session, filename=file.filename) }}">
                  {{ file.filename }}
                </a>
              {% else %}
                {{ file.filename }}
              {% endif %}
            </td>
            <td>
              {% if file.hash_file and session %}
                <a href="{{ url_for('download.download_file', session=session, filename=file.hash_file) }}">
                  {{ file.hash_file }}
                </a>
              {% else %}
                ‚Äî
              {% endif %}
            </td>
            <td>{{ "‚úÖ" if file.encrypted else "‚ùå" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <script>
    // File drop zone handling
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-upload');
    const cleanBtn = document.getElementById('clean-memory-btn');
    const cleanBtnText = document.getElementById('clean-btn-text');
    const uploadForm = document.getElementById('upload-form');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      fileInput.files = e.dataTransfer.files;
      // Trigger status update after file selection
      setTimeout(updateButtonStatus, 100);
    });

    // Update button when files are selected
    fileInput.addEventListener('change', () => {
      setTimeout(updateButtonStatus, 100);
    });

    // Function to update clean button status
    function updateButtonStatus() {
      fetch('{{ url_for("session_clean.check_status") }}', {
        method: 'GET',
        cache: 'no-cache'
      })
      .then(response => response.json())
      .then(data => {
        const hasDirtyData = data.has_dirty_data;
        
        // Update button appearance
        cleanBtn.className = 'clean-btn ' + (hasDirtyData ? 'dirty' : 'clean disabled');
        cleanBtn.disabled = !hasDirtyData;
        cleanBtnText.textContent = hasDirtyData ? 'Clean Memory' : 'Memory Clean';
        
        console.log('Button status updated:', hasDirtyData ? 'dirty' : 'clean');
      })
      .catch(error => {
        console.error('Error checking status:', error);
        // Fallback to assuming dirty
        cleanBtn.className = 'clean-btn dirty';
        cleanBtn.disabled = false;
        cleanBtnText.textContent = 'Clean Memory';
      });
    }

    // Update status on page load
    document.addEventListener('DOMContentLoaded', updateButtonStatus);

    // Update status periodically (every 10 seconds)
    setInterval(updateButtonStatus, 10000);

    // Update status after upload form submission
    uploadForm.addEventListener('submit', () => {
      // Small delay to let the upload process
      setTimeout(updateButtonStatus, 1000);
    });

    // Handle form submission (page refresh detection)
    window.addEventListener('beforeunload', () => {
      // This triggers server-side session cleanup on page refresh
      navigator.sendBeacon('{{ url_for("session_clean.check_status") }}');
    });

    // Update button status when page becomes visible again
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        updateButtonStatus();
      }
    });
  </script>

</body>
</html>